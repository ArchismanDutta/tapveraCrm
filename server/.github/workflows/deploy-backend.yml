name: Deploy Backend (PRODUCTION)

on:
  push:
    branches:
      - prod

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy backend to EC2 (prod)
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            set -e

            echo "üöÄ PRODUCTION DEPLOY STARTED"

            cd ~/apps/tapveraCrm/server

            echo "üì• Fetching prod branch"
            git fetch origin prod
            git checkout prod
            git pull origin prod

            echo "üì¶ Installing production dependencies"
            npm ci --omit=dev

            echo "‚ôªÔ∏è Reloading PM2 (zero downtime)"
            pm2 reload tapvera-backend

            echo "‚úÖ PRODUCTION DEPLOY COMPLETE"
